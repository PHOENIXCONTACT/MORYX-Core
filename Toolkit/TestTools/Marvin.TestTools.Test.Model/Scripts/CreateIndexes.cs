using System;
using System.Collections.Generic;
using System.Text;
using Marvin.Model;

namespace Marvin.TestTools.Test.Model
{
	/// <summary>
	/// MARVIN Script class to generate indexes for generated tables                                       
	/// This is autogenerated code, therefor any modifications are useless and will be lost on recreation. 
	///                                                                                                    
	/// If you have questions or modification requests contact Thomas Fuchs.                               
	/// </summary>
	internal class TestModelIndexesScipt : IDatabaseScript
	{
		/// <summary>
		/// Internal class representing a single index
		/// </summary>
		private class Index
		{
			internal Index(string name, string table, string columns)
			{
				Name = name;
				Table = table;
				Columns = columns;
			}

			internal string Name { get; private set; }

			internal string Table { get; private set; }

			internal string Columns { get; private set; }
		}

		public string Name { get { return "TestModelIndexesScipt"; } }

    public bool IsCreationScript { get { return true; } }

		public string GetText()
		{
			var indexes = GenerateIndexArray();
			return BuildScript(indexes);	
		}

		private IEnumerable<Index> GenerateIndexArray()
		{
			var indexes = new List<Index>
			{
				new Index("IDX_HugePoco_Float1", "\"HugePoco\"", "\"Float1\""),
				new Index("IDX_RecursiveReference_Count", "\"RecursiveReference\"", "\"Count\""),
				new Index("IDX_TopParent_Updated", "\"TopParent\"", "\"Updated\""),
				new Index("IDX_TopParent_Number", "\"TopParent\"", "\"Number\""),
				new Index("IDX_HugePoco_Float2_Name2_Number2", "\"HugePoco\"", "\"Float2\", \"Name2\", \"Number2\""),
				new Index("IDX_HugePoco_Float2_Name2_Number2_Float3_Name3_Number3", "\"HugePoco\"", "\"Float2\", \"Name2\", \"Number2\", \"Float3\", \"Name3\", \"Number3\""),
				new Index("IDX_HugePoco_Float3_Name3_Number3", "\"HugePoco\"", "\"Float3\", \"Name3\", \"Number3\""),
				new Index("IDX_TopParent_Created_Updated", "\"TopParent\"", "\"Created\", \"Updated\""),
				new Index("IDX_TopParent_Created_Number", "\"TopParent\"", "\"Created\", \"Number\""),
				new Index("IDX_TopParent_Updated_Number", "\"TopParent\"", "\"Updated\", \"Number\""),
			};
			return indexes;
		}

		private string BuildScript(IEnumerable<Index> indexes)
		{
			var builder = new StringBuilder();
			const string buildString = 
@"CREATE INDEX {0} ON {1} USING btree ({2});";
			foreach (var index in indexes)
			{
				builder.AppendLine(string.Format(buildString, index.Name, index.Table, index.Columns));
			}
			return builder.ToString();
		}
	}
}
